<div class="row">
  <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
    <h1 class="page-title txt-color-blueDark">
      <i class="fa fa-exchange fa-fw "></i> 
        Buy &amp; Sell 
    </h1>
  </div>
</div>

<section id="widget-grid" class="buySellGrid"> <!-- widget grid -->
  <div class="row"> <!-- row -->
    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12"> <!-- NEW WIDGET START -->
      <!-- Widget ID (each widget will need unique ID)-->
      <div class="jarviswidget defaultWidgetColor" id="wid-id-buySellWizard" data-widget-editbutton="false" data-widget-deletebutton="false">
          <header>
            <span class="widget-icon"> <i class="fa fa-rocket"></i> </span>
            <h2>Make a Trade</h2>
          </header>
          <div> <!-- widget div-->
            <div class="widget-body"> <!-- widget content -->
                <div class="row">
                    <form id="wizard-1">
                        <div id="buySellWizard" class="col-md-12" data-bind="validationOptions: { insertMessages: false }">
                            <div class="form-bootstrapWizard">
                                <ul class="bootstrapWizard form-wizard">
                                    <li class="active" data-target="#step1">
                                        <a href="#tab1" data-toggle="tab"> <span class="step">1</span> <span class="title">Select Assets</span> </a>
                                    </li>
                                    <li data-target="#step2">
                                        <a href="#tab2" data-toggle="tab"> <span class="step">2</span> <span class="title">Select Amounts</span> </a>
                                    </li>
                                    <li data-target="#step3">
                                        <a href="#tab3" data-toggle="tab"> <span class="step">3</span> <span class="title">Confirm</span> </a>
                                    </li>
                                </ul>
                                <div class="clearfix"></div>
                            </div>
                            <div class="tab-content">
                                <div class="tab-pane active" id="tab1">
                                    <div class="row" style="max-width: 1000px;">
                                        <div class="col-md-2"><span>I want to buy:</span></div>
                                        <div class="col-md-4">
                                            <div class="btn-group" data-toggle="buttons" style="min-width: 300px;">
                                              <label class="radioBtn btn btn-lg" data-bind="css: { 'btn-success': selectedBuyAsset() == 'XCP' }">
                                                <input type="radio" name="buyAsset" id="buyXCP" value="XCP" data-bind="btnGroupChecked: selectedBuyAsset">XCP</label>
                                                <!-- , attr: {disabled: selectedSellAsset() == 'XCP' ? 'disabled' : null }" -->
                                              <label class="radioBtn btn btn-lg" data-bind="css: { 'btn-success': selectedBuyAsset() == 'BTC' }">
                                                <input type="radio" name="buyAsset" id="buyBTC" value="BTC" data-bind="btnGroupChecked: selectedBuyAsset">BTC</label>
                                              <label class="radioBtn btn btn-lg" data-bind="css: { 'btn-success': selectedBuyAsset() == 'Other' }">
                                                <input type="radio" name="buyAsset" id="buyOther" value="Other" data-bind="btnGroupChecked: selectedBuyAsset">Other Asset</label>
                                            </div>
                                            <span class="invalid" data-bind="validationMessage: selectedBuyAsset"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group" data-bind="fadeVisible: selectedBuyAsset() == 'Other'">
                                                <span class="input-group-addon"><i class="fa fa-tags fa-lg fa-fw"></i></span>
                                                <input id="otherBuyAssetName" class="form-control input-lg" type="text"
                                                 placeholder="Enter asset name" style="min-width: 280px;max-width: 350px;"
                                                 data-bind="value: selectedBuyAssetOther"/>
                                            </div>
                                            <span class="invalid" data-bind="validationMessage: selectedBuyAssetOther"></span>
                                        </div>
                                    </div>
                                    <div class="row" style="max-width: 1000px;">
                                        <div class="col-md-2"><span>I want to sell:</span></div>
                                        <div class="col-md-4">
                                            <div class="btn-group" data-toggle="buttons" style="min-width: 300px;">
                                              <label class="radioBtn btn btn-lg" data-bind="css: { 'btn-primary': selectedSellAsset() == 'XCP' }">
                                                <input type="radio" name="sellAsset" id="sellXCP" value="XCP" data-bind="btnGroupChecked: selectedSellAsset">XCP</label>
                                              <label class="radioBtn btn btn-lg" data-bind="css: { 'btn-primary': selectedSellAsset() == 'BTC' }">
                                                <input type="radio" name="sellAsset" id="sellBTC" value="BTC" data-bind="btnGroupChecked: selectedSellAsset">BTC</label>
                                              <label class="radioBtn btn btn-lg" data-bind="css: { 'btn-primary': selectedSellAsset() == 'Other' }">
                                                <input type="radio" name="sellAsset" id="sellOther" value="Other" data-bind="btnGroupChecked: selectedSellAsset">Other Asset</label>
                                            </div>
                                            <span class="invalid" data-bind="validationMessage: selectedSellAsset"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group" data-bind="fadeVisible: selectedSellAsset() == 'Other'">
                                                <select class="form-control input-lg" style="min-width: 335px;max-width: 405px;"
                                                    data-bind="options: myAssets, optionsCaption: 'Choose...', value: selectedSellAssetOther">
                                                </select>
                                                <span class="invalid" data-bind="validationMessage: selectedSellAssetOther"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" style="min-width:300px;max-width: 1000px;padding-bottom: 0px;">
                                        <div class="col-md-2"><span>From address:</span></div>
                                        <div class="col-md-10">
                                            <select id="buySellFromAddress" data-bind="options: availableAddressesWithBalance, optionsValue: 'ADDRESS', optionsText: 'SELECT_LABEL', select2: {  minimumResultsForSearch: 10, containerCssClass: 'addressSelect', escapeMarkup: function(m) { return m; } }, value: selectedAddress" data-placeholder="Enter address"></select>
                                            <span class="invalid" data-bind="validationMessage: selectedAddress"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tab2">
                                    <div data-bind="visible: currentTab() == 2 && currentMarketUnitPrice() && !overrideMarketPrice()" style="display:none;">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <span>You have <b><span class="sellColor" data-bind="text: totalBalanceAvailForSale"></span>
                                                <span class="sellColor" data-bind="text: sellAsset"></span></b> at the selected address.
                                                <br/>At the current market rate of <b><span data-bind="text: currentMarketUnitPrice"></span>
                                                <span data-bind="text: quoteAsset"></span> per each <span data-bind="text: baseAsset"></span></b>,
                                                you can afford up to <b><span class="buyColor" data-bind="text: numberWithCommas(maxAfford())"></span> <span class="buyColor" data-bind="text: buyAsset"></span>.</b>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row" style="max-width: 1000px;">
                                            <div class="col-md-4">Quantity <b class="buyColor"><span data-bind="text: buyAsset"></span></b> to buy:<br/><a href="#" data-bind="click: function() { overrideMarketPrice(true) && currentMarketUnitPrice(null) }" style="font-size:11px;position:relative;bottom:5px">Override Market Rate</a></div>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="fa fa-arrow-circle-o-down fa-lg fa-fw"></i></span>
                                                    <input class="form-control input-lg" type="text" style="max-width: 300px"
                                                     data-bind="value: selectedBuyAmount, attr: {placeholder: 'Quantity ' + buyAsset()}, valueUpdate: 'afterkeydown'" />
                                                </div>
                                                <span class="invalid" data-bind="validationMessage: selectedBuyAmount"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div data-bind="visible: currentTab() == 2 && (currentMarketUnitPrice() == null || overrideMarketPrice())" style="display:none">
                                        <div class="row" data-bind="fadeVisible: currentTab() == 2 && currentMarketUnitPrice() == null">
                                            <div class="col-md-12">
                                                <span class="errorRed">There is currently insufficient data to determine a fair market price for your purchase.</span>
                                                <br/><span>You have <b><span class="sellColor" data-bind="text: totalBalanceAvailForSale"></span>
                                                <span class="sellColor" data-bind="text: sellAsset"></span></b> at the selected address.                                                
                                            </div>
                                        </div>
                                        <div class="row" style="max-width: 1000px;">
                                            <div class="col-md-4">Quantity <b class="buyColor"><span data-bind="text: buyAsset"></span></b> to buy:</div>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="fa fa-arrow-circle-o-down fa-lg fa-fw"></i></span>
                                                    <input class="form-control input-lg" type="text"
                                                        data-bind="value: selectedBuyAmount, attr: {placeholder: 'Quantity ' + buyAsset()}, valueUpdate: 'afterkeydown'"
                                                        style="max-width: 300px;" />
                                                </div>
                                                <span class="invalid" data-bind="validationMessage: selectedBuyAmount"></span>
                                            </div>
                                        </div>
                                        <div class="row" style="max-width: 1000px;padding-bottom:20px !important">
                                            <div class="col-md-4">Quantity <b class="sellColor"><span data-bind="text: sellAsset"></span></b> to sell:</div>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="fa fa-arrow-circle-o-up fa-lg fa-fw"></i></span>
                                                    <input class="form-control input-lg" type="text"
                                                        data-bind="value: selectedSellAmountCustom, attr: {placeholder: 'Quantity ' + sellAsset()}, valueUpdate: 'afterkeydown'"
                                                        style="max-width: 300px;" />
                                                </div>
                                                <span class="invalid" data-bind="validationMessage: selectedSellAmountCustom"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" data-bind="fadeVisibleInOnly: currentTab() == 2 && unitPrice() && selectedBuyAmount()" style="padding-bottom: 0px;margin-top:15px;">
                                        <div class="col-sm-12">
                                            <span data-bind="fadeVisible: currentMarketUnitPrice() && !overrideMarketPrice()">At the market rate,
                                                your purchase of <b><span class="buyColor" data-bind="text: numberWithCommas(selectedBuyAmount())"></span>
                                                <span class="buyColor" data-bind="text: buyAsset"></span></b>
                                                will cost you <b><span class="sellColor" data-bind="text: numberWithCommas(selectedSellAmountAtMarket())"></span>
                                                <span class="sellColor" data-bind="text: sellAsset"></span></b>.
                                            </span>
                                            <span data-bind="fadeVisible: (currentMarketUnitPrice() == null || overrideMarketPrice()) && (selectedSellAmountCustom() && selectedSellAmountCustom() > 0) ">
                                                The effective unit price of your <b><span data-bind="text: dispAssetPair"></span></b> order is
                                                <b><span data-bind="text: unitPrice"></span></b>
                                                (i.e. <span data-bind="text: numberWithCommas(unitPrice())"></span>
                                                <span data-bind="text: quoteAsset"></span> per each <span data-bind="text: baseAsset"></span>).
                                            </span>
                                            <span data-bind="fadeVisibleInOnly: currentTab() == 2 && sellAmountRemainingAfterSale() != null && sellAmountRemainingAfterSale() >= 0">
                                                <br/>After the sale, you will have <b><span class="sellColor" data-bind="text: dispSellAmountRemainingAfterSale"></span>
                                                <span class="sellColor" data-bind="text: sellAsset"></span></b> remaining at
                                                your address <b><span data-bind="text: dispSelectedAddressWithLabel"></span></b>.
                                            </span>
                                            <span data-bind="fadeVisibleInOnly: currentTab() == 2 && sellAmountRemainingAfterSale() < 0">
                                                <br/><span class="errorRedColor">Your purchase would exceed your available balance
                                                by <b><span data-bind="text: dispSellAmountRemainingAfterSaleAbs"></span>
                                                <span data-bind="text: sellAsset"></span></b>.</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tab3">
                                    <table class="table table-bordered" style="max-width: 800px;">â€‹
                                        <thead></thead>
                                        <tbody>
                                            <tr>
                                                <td>Buy</td>
                                                <td><b><span class="buyColor" data-bind="text: numberWithCommas(selectedBuyAmount())"></span>&nbsp;
                                                    <span class="buyColor" data-bind="text: buyAsset"></span></b></td>
                                            </tr>
                                            <tr>
                                                <td>Sell</td>
                                                <td><b><span class="sellColor" data-bind="text: numberWithCommas(selectedSellAmount())"></span>&nbsp;
                                                    <span class="sellColor" data-bind="text: sellAsset" placeholder="Enter amount"></span></b></td>
                                            </tr>
                                            <tr>
                                                <td>Unit Price</td>
                                                <td><b><span data-bind="text: unitPrice()"></span>&nbsp;
                                                    <span data-bind="text: quoteAsset"></span> per each <span data-bind="text: baseAsset"></span></b>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    After the sale, you will have <b><span class="sellColor" data-bind="text: dispSellAmountRemainingAfterSale"></span>
                                    <span class="sellColor" data-bind="text: sellAsset"></span></b> remaining at
                                    your address <b><span data-bind="text: dispSelectedAddressWithLabel"></span></b>.                                    
                                </div>
    
                                <div class="form-actions">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <ul class="pager wizard no-margin">
                                                <li class="previous disabled">
                                                    <a href="javascript:void(0);" class="btn btn-lg btn-default"> Previous </a>
                                                </li>
                                                <li class="next">
                                                    <a href="javascript:void(0);" class="btn btn-lg txt-color-darken"> Next </a>
                                                </li>
                                                <li class="next finish" style="display:none;">
                                                    <a href="javascript:void(0);" class="btn btn-lg btn-success">Confirm &amp; Place Order</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
    
                            </div>
                        </div>
                    </form>
                </div>
            </div> <!-- end widget content -->
          </div> <!-- end widget div -->
      </div> <!-- end widget -->
    </article> <!-- WIDGET END -->
  </div> <!-- end row -->

  <div data-bind="fadeVisible: showPriceChart" class="row"> <!-- row -->
    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12"> <!-- NEW WIDGET START -->
      <div class="jarviswidget defaultWidgetColor" id="wid-id-priceChart" data-widget-editbutton="false" data-widget-deletebutton="false">
        <header>
            <span class="widget-icon"> <i class="fa fa-bar-chart-o"></i> </span>
            <h2>Price History for <span data-bind="text: dispAssetPair"></span></h2>
        </header>
        <div> <!-- widget div-->
            <div class="widget-body no-padding"> <!-- widget content -->
                <div class="row">
                    <div class="col-lg-9">
                        <div id="priceHistory" style="height: 500px; min-width: 500px"></div>
                    </div>
                    <div class="col-lg-3">
                        <div>
                            <table id="orderBook" class="table table-striped table-bordered table-condensed">
                                <thead>
                                    <tr>
                                        <th>Unit Price</th>
                                        <th>Quantity (Count)</th>
                                        <th>Depth</th>
                                    </tr>
                                </thead>
                                <tbody data-bind="foreach: askBook"> <!-- descending order -->
                                    <tr>
                                        <td data-bind="text: unit_price"></td>
                                        <td data-bind="text: amount.toFixed(8) + ' (' + count + ')'"></td> <!-- amount (count) -->
                                        <td data-bind="text: numberWithCommas(depth)"></td>
                                    </tr>
                                </tbody>
                                <tbody>
                                    <tr>
                                        <td class="median"> <!-- median within the spread -->
                                            <center><span style="font-weight:bold;font-size: 14px;"
                                                  data-bind="text: bidAskMedian()">
                                            </span></center>
                                        </td>
                                        <td class="median"><center><b>--</b></center></td>
                                        <td class="median"><center><b>--</b></center></td>
                                    </tr>
                                </tbody>
                                <tbody data-bind="foreach: bidBook"> <!-- descending order -->
                                        <td data-bind="text: unit_price"></td>
                                        <td data-bind="text: amount.toFixed(8) + ' (' + count + ')'"></td>
                                        <td data-bind="text: numberWithCommas(depth)"></td>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div> <!-- end widget content -->
        </div> <!-- end widget div -->
      </div> <!-- end widget -->
    </article> <!-- WIDGET END -->
  </div> <!-- end row -->

  <div data-bind="fadeVisible: showOpenOrders" class="row"> <!-- row -->
    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12"> <!-- NEW WIDGET START -->
      <div class="jarviswidget defaultWidgetColor" id="wid-id-openOrders" data-widget-editbutton="false" data-widget-deletebutton="false">
        <header>
            <span class="widget-icon"> <i class="fa fa-spinner"></i> </span>
            <h2>Your <span data-bind="text: dispAssetPair"></span> Open Orders for <span data-bind="text: dispSelectedAddressWithLabel"></span></h2>
        </header>
        <div> <!-- widget div-->
            <div class="widget-body no-padding"> <!-- widget content -->
                <div class="widget-body-toolbar">
                </div>
                <table id="openOrders" class="table table-striped table-hover dt_basic" style="width: 100% !important;">
                    <thead>
                        <tr>
                            <th>Tx ID</th>
                            <th>When Created</th>
                            <th>Buying</th>
                            <th>Selling</th>
                            <th>Price</th>
                            <th>Buy Qty Left</th>
                            <th>Sell Qty Left</th>
                            <th>Expires In</th>
                            <th>Fee Provided</th>
                            <th>Fee Required</th>
                            <th>Operations</th>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach: openOrders">
                        <tr>
                            <td><a target="_blank" data-bind="text: tx_index, attr: { href: !USE_TESTNET ? 'http://blockscan.com/tx.aspx?q=' + tx_index : null }"></a></td> <!-- link to block tx at blockscan -->
                            <td data-bind="timeago: new Date(block_time * 1000)"></td>
                            <td data-bind="text: derivePendingOrderAssetAmount(get_asset, get_amount) + ' ' + get_asset"></td>
                            <td data-bind="text: derivePendingOrderAssetAmount(give_asset, give_amount) + ' ' + give_asset"></td>
                            <td><a target="_blank" data-bind="text: derivePendingOrderAssetPrice(get_asset, get_amount, give_asset, give_amount)"></a></td>
                            <td data-bind="text: derivePendingOrderAssetAmount(get_asset, get_remaining) + ' ' + get_asset"></td>
                            <td data-bind="text: derivePendingOrderAssetAmount(give_asset, give_remaining) + ' ' + give_asset"></td>
                            <td data-bind="html: derivePendingOrderExpiresIn(block_index, expiration)"></td>
                            <td data-bind="text: fee_provided ? (Decimal.round(new Decimal(fee_provided).div(UNIT)).toString() + 'BTC') : ''"></td>                            
                            <td data-bind="text: fee_required ? (Decimal.round(new Decimal(fee_required).div(UNIT)).toString() + 'BTC') : ''"></td>
                            <td>
                                <a href="#" data-bind="click: $parent.cancelOrder" class="btn btn-danger btn-xs">Cancel Order</a>
                            </td>                            
                        </tr>
                    </tbody>
                </table>
            </div> <!-- end widget content -->
        </div> <!-- end widget div -->
      </div> <!-- end widget -->
    </article> <!-- WIDGET END -->
  </div> <!-- end row -->
  
  <div data-bind="fadeVisible: showTradeHistory && tradeHistory().length > 0" class="row"> <!-- row -->
    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12"> <!-- NEW WIDGET START -->
      <div class="jarviswidget defaultWidgetColor" id="wid-id-tradeChart" data-widget-editbutton="false" data-widget-deletebutton="false">
        <header>
            <span class="widget-icon"> <i class="fa fa-table"></i> </span>
            <h2>Trade History for <span data-bind="text: dispAssetPair"></span></h2>
        </header>
        <div> <!-- widget div-->
            <div class="widget-body no-padding"> <!-- widget content -->
                <div class="widget-body-toolbar">
                </div>
                <table id="tradeHistory" class="table table-striped table-hover datatable_tabletools" style="width: 100% !important;">
                    <thead>
                        <tr>
                            <th>Block</th>
                            <th>Block Time</th>
                            <th>Order 1</th>
                            <th>Address 1</th>
                            <th>Order 2</th>
                            <th>Address 2</th>
                            <th>Quantity <span data-bind="text: baseAsset"></span></th>
                            <th>Quantity <span data-bind="text: quoteAsset"></span></th>
                            <th>Unit Price</th>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach: tradeHistory">
                        <tr>
                            <td><a target="_blank" data-bind="text: block_index, attr: { href: BLOCKEXPLORER_URL + '/blocks?blockHeight=' + block_index }"></a></td> <!-- link to block tx at insight -->
                            <td data-bind="text: moment(block_time).format('MMM Do YYYY, h:mm:ss a')"></td> <!-- datetime formatted string -->
                            <td><a target="_blank" data-bind="text: order_match_tx0_index, attr: { href: !USE_TESTNET ? 'http://blockscan.com/tx.aspx?q=' + order_match_tx0_index : null }"></a></td> <!-- link to TX at blockscan -->
                            <td><a target="_blank" data-bind="text: order_match_tx0_address, attr: { href: !USE_TESTNET ? 'http://blockscan.com/address.aspx?q=' + order_match_tx0_address : null }"></a></td> <!-- link to source addr at blockscan -->
                            <td><a target="_blank" data-bind="text: order_match_tx1_index, attr: { href: !USE_TESTNET ? 'http://blockscan.com/tx.aspx?q=' + order_match_tx1_index : null }"></a></td> <!-- link to TX at blockscan -->
                            <td><a target="_blank" data-bind="text: order_match_tx1_address, attr: { href: !USE_TESTNET ? 'http://blockscan.com/address.aspx?q=' + order_match_tx1_address : null }"></a></td> <!-- link to source addr at blockscan -->
                            <td data-bind="text: base_amount_normalized + ' ' + base_asset"></td>
                            <td data-bind="text: quote_amount_normalized + ' ' + quote_asset"></td>
                            <td data-bind="text: unit_price"></td>
                        </tr>
                    </tbody>
                </table>
            </div> <!-- end widget content -->
        </div> <!-- end widget div -->
      </div> <!-- end widget -->
    </article> <!-- WIDGET END -->
  </div> <!-- end row -->
</section>

<script type="text/javascript">
  pageSetUp(); //init smartadmin featureset
  loadScript("xcp/js/components/buysell.js", function() {
    //This code is run on each visit to the page
    window.BUY_SELL = new BuySellWizardViewModel();

    ko.applyBindings(BUY_SELL, document.getElementsByClassName("buySellGrid")[0]);
    
    BUY_SELL.init();
  
    $(window).resize(BUY_SELL.dataTableResponsive);
    $(window).on('hashchange', function() {
      $(window).off("resize", BUY_SELL.dataTableResponsive);
    });
  });
</script>
